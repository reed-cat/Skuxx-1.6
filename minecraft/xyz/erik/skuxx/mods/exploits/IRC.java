package xyz.erik.skuxx.mods.exploits;

import net.minecraft.client.Minecraft;
import net.minecraft.client.gui.GuiTextField;
import net.minecraft.network.play.client.C01PacketChatMessage;
import net.minecraft.util.ChatComponentText;
import org.jibble.pircbot.IrcException;
import org.lwjgl.input.Keyboard;
import xyz.erik.api.config.vals.Bool;
import xyz.erik.api.mod.Mod;
import xyz.erik.api.notification.Notification;
import xyz.erik.api.notification.NotificationManager;
import xyz.erik.api.utils.TrayIcon;
import xyz.erik.skuxx.Skuxx;
import xyz.erik.skuxx.event.EventTarget;
import xyz.erik.skuxx.event.events.EventPacket;
import xyz.erik.skuxx.event.events.KeyPressEvent;
import xyz.erik.skuxx.mods.Category;
import xyz.erik.skuxx.mods.untoggleable.Render;
import xyz.erik.skuxx.ui.irc.IRCScreen;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class IRC
extends Mod
{


    private Bool notifications = new Bool("Notify",false);
    public static List<String> lastMessages = new ArrayList<>();

    public IRC()
    {
        addSet(notifications);
        setVisible(false);

        setCategory(Category.EXPLOITS);
    }

    @EventTarget
    private void onSendMessage(EventPacket eventPacket) {
        if (eventPacket.type == EventPacket.Type.SEND) {
            if (eventPacket.packet instanceof C01PacketChatMessage) {
                String text = ((C01PacketChatMessage)eventPacket.getPacket()).getMessage();
                if (text.startsWith("@") && !text.startsWith("@!")) {
                    Skuxx.getInstance().getMyself().sendMessage(text.replace("@",""));
                //    Minecraft.getMinecraft().thePlayer.addChatMessage(new ChatComponentText("§3IRC- §8[§6" + Skuxx.getUser()+"§8]:§r "+(text.replace("@",""))));
                    lastMessages.add(Skuxx.getUser() + ": " + text.replace("@",""));
                    if(lastMessages.size() > 5) {
                        lastMessages.remove(0);
                    }
                    Render.LEAVE_FOCUS = 100;

                    Minecraft.getMinecraft().ircScreen.addChatMessage(Skuxx.getUser(),text.replace("@",""));

                    setRunning(1);
                    eventPacket.setCancelled(true);
                }
            }
        }
    }

    public void getMessage(String sender,String message) {
        lastMessages.add(sender + ": " + message);
        if(lastMessages.size() > 5) {
            lastMessages.remove(0);
        }
        int index = lastMessages.size() -1;

        if (this.getState() && notifications.isState() && !(Minecraft.getMinecraft().currentScreen instanceof IRCScreen)) {
            TrayIcon.addNotification("["+sender + "]: " + message,"Skuxx");
        }
        new Thread(new Runnable() {
            @Override
            public void run() {
                try {
                    Thread.sleep(5000);
                }catch (InterruptedException e){}
                lastMessages.remove(index);
            }
        }).start();

    }

    @EventTarget
    private void onKeyPress(KeyPressEvent event) {
        if (event.getKey() == Keyboard.KEY_I && getMinecraft().gameSettings.keyBindSneak.pressed) {
            if (!Skuxx.getInstance().getMyself().isConnected() || Skuxx.getInstance().getMyself().getServer() == null
                    || Skuxx.getInstance().getMyself().getName()==null) {
                try {
                    Minecraft.getMinecraft().ircScreen.addChatMessage("Server","Reconnected to Skuxx IRC.");
                        Skuxx.getInstance().getMyself().connect("chat.freenode.net");
                    }catch (IOException e){
                    Minecraft.getMinecraft().ircScreen.addChatMessage("Server","Error while connecting Skuxx IRC.");


                }catch (IrcException asd){
                    Minecraft.getMinecraft().ircScreen.addChatMessage("Server","Error while connecting Skuxx IRC.");
                }
                    Skuxx.getInstance().getMyself().joinChannel("#skuxx0");
                    //      myself.changeNick(Skuxx.getUser());
                    Skuxx.getInstance().getMyself().sendMessage("skuxx a giris yapti.");
            }

            getMinecraft().ircScreen.updateOnlineUsers();
            getMinecraft().displayGuiScreen(this.getMinecraft().ircScreen);


        }
    }


}
